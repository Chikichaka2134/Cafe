<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Menu Manager</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Link to separate custom CSS file -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="min-h-screen flex flex-col">

    <!-- Main Navigation Bar -->
    <nav class="bg-gray-800 shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <span class="text-xl font-bold text-white tracking-wider">üçΩÔ∏è Restaurant Manager (Python)</span>
                </div>
                <div class="flex space-x-4">
                    <button id="nav-menus" onclick="navigate('menus')" class="text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out">
                        Menus
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-content" class="flex-grow max-w-7xl mx-auto w-full p-4 sm:p-6 lg:p-8">
        <!-- Content injected via JS -->
    </main>

    <!-- Modal for Confirmation -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-gray-800">Confirmation</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const state = {
            view: 'menus',
            menus: [],
            dishes: [],
            selectedMenuId: null,
            currentFormMode: { type: null, data: null, isEdit: false }
        };

        const appContent = document.getElementById('app-content');

        // --- API UTILS ---
        // These functions replace the Firebase logic

        async function fetchMenus() {
            const res = await fetch('/api/menus');
            state.menus = await res.json();
            render();
        }

        async function fetchDishes(menuId) {
            const url = menuId ? `/api/dishes?menu_id=${menuId}` : '/api/dishes';
            const res = await fetch(url);
            state.dishes = await res.json();
            render();
        }

        async function apiCall(endpoint, method, body = null) {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const res = await fetch(endpoint, options);
                if (!res.ok) throw new Error('API Error');
                return await res.json();
            } catch (err) {
                console.error(err);
                alert("Operation failed. See console.");
            }
        }

        // --- ACTIONS ---

        async function saveRecord(type, data, id) {
            const endpoint = type === 'menu' ? '/api/menus' : '/api/dishes';
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${endpoint}/${id}` : endpoint;

            await apiCall(url, method, data);

            // Refresh data
            if (type === 'menu') {
                await fetchMenus();
                navigate('menus');
            } else {
                await fetchDishes(state.selectedMenuId);
                navigate('dishes', state.selectedMenuId);
            }
        }

        function deleteRecord(type, id) {
            showModal(`Delete ${type}`, `Are you sure?`, async () => {
                const endpoint = type === 'menu' ? '/api/menus' : '/api/dishes';
                await apiCall(`${endpoint}/${id}`, 'DELETE');
                
                if (type === 'menu') {
                    await fetchMenus();
                } else {
                    await fetchDishes(state.selectedMenuId);
                }
            });
        }

        // --- NAVIGATION ---

        function navigate(view, menuId = null) {
            state.view = view;
            state.selectedMenuId = menuId;
            if (view === 'menus') fetchMenus();
            if (view === 'dishes' && menuId) fetchDishes(menuId);
        }

        function openCreateForm(type) {
            state.currentFormMode = {
                type: type,
                data: type === 'menu' ? { name: '', description: '' } : { name: '', description: '', price: '', menuId: state.selectedMenuId },
                isEdit: false
            };
            renderFormView();
        }

        function openEditForm(type, id) {
            const data = type === 'menu' 
                ? state.menus.find(m => m.id === id) 
                : state.dishes.find(d => d.id === id);
            
            state.currentFormMode = { type, data: {...data}, isEdit: true };
            renderFormView();
        }

        // --- VIEWS ---

        function render() {
            if (state.view === 'menus') renderMenusView();
            else if (state.view === 'dishes') renderDishesView();
        }

        function renderMenusView() {
            appContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Restaurant Menus</h1>
                    <button onclick="openCreateForm('menu')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-md">New Menu</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${state.menus.map(menu => `
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex flex-col justify-between">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">${menu.name}</h2>
                                <p class="text-gray-500 mt-2 text-sm">${menu.description || ''}</p>
                            </div>
                            <div class="mt-4 flex space-x-2">
                                <button onclick="navigate('dishes', ${menu.id})" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-3 rounded-lg text-sm">View Dishes</button>
                                <button onclick="openEditForm('menu', ${menu.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-3 rounded-lg text-sm">Edit</button>
                                <button onclick="deleteRecord('menu', ${menu.id})" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderDishesView() {
            const menu = state.menus.find(m => m.id === state.selectedMenuId);
            if (!menu) return;

            appContent.innerHTML = `
                <div class="mb-4">
                    <button onclick="navigate('menus')" class="text-blue-600 hover:text-blue-800 mb-4">Back to Menus</button>
                    <h1 class="text-3xl font-bold text-gray-800">${menu.name} Dishes</h1>
                </div>
                <div class="flex justify-end mb-6">
                    <button onclick="openCreateForm('dish')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-md">New Dish</button>
                </div>
                <div class="bg-white shadow-xl rounded-xl overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${state.dishes.map(dish => `
                                <tr>
                                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${dish.name}</td>
                                    <td class="px-6 py-4 text-sm text-gray-700">$${dish.price.toFixed(2)}</td>
                                    <td class="px-6 py-4 text-right text-sm font-medium">
                                        <button onclick="openEditForm('dish', ${dish.id})" class="text-yellow-600 mr-3">Edit</button>
                                        <button onclick="deleteRecord('dish', ${dish.id})" class="text-red-600">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        }

        function renderFormView() {
            const { type, data, isEdit } = state.currentFormMode;
            appContent.innerHTML = `
                <div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-2xl border-t-4 border-blue-500">
                    <h1 class="text-3xl font-bold mb-6">${isEdit ? 'Edit' : 'New'} ${type}</h1>
                    <form id="record-form" class="space-y-6">
                        <div><label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" name="name" value="${data.name}" required class="mt-1 block w-full px-4 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea name="description" class="mt-1 block w-full px-4 py-2 border rounded-lg">${data.description}</textarea></div>
                        ${type === 'dish' ? `<div><label class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" step="0.01" name="price" value="${data.price}" required class="mt-1 block w-full px-4 py-2 border rounded-lg"></div>` : ''}
                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="button" onclick="navigate('${type === 'menu' ? 'menus' : 'dishes'}', ${data.menuId})" class="px-5 py-2 border rounded-lg">Cancel</button>
                            <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg">${isEdit ? 'Save' : 'Create'}</button>
                        </div>
                    </form>
                </div>`;
            
            document.getElementById('record-form').onsubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    menuId: data.menuId
                };
                if (type === 'dish') newData.price = formData.get('price');
                saveRecord(type, newData, isEdit ? data.id : null);
            };
        }

        // Modal Utils
        const modalContainer = document.getElementById('modal-container');
        function showModal(title, msg, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = msg;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            
            const confirmBtn = document.getElementById('modal-confirm');
            const newConfirm = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
            
            newConfirm.onclick = () => {
                onConfirm();
                closeModal();
            };
            document.getElementById('modal-cancel').onclick = closeModal;
        }
        function closeModal() {
            modalContainer.classList.add('hidden');
            modalContainer.classList.remove('flex');
        }

        // Initial Load
        fetchMenus();
    </script>
</body>
</html>